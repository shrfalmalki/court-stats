<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† - Ø§Ù„Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦ÙŠØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Akhbar:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box; margin: 0; padding: 0;
            font-family: 'Akhbar', 'Segoe UI', Tahoma, sans-serif;
            background: #f0f8ff; overflow-x: hidden;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; }
        .official-header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border: 2px solid rgba(55, 151, 119, 0.3); border-radius: 20px;
            padding: 30px; margin-bottom: 20px; text-align: right;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .official-title { font-size: 22px; font-weight: 700; color: #000; }
        .header {
            background: rgba(55, 151, 119, 0.85); backdrop-filter: blur(20px);
            color: white; padding: 25px; border-radius: 20px; margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(55, 151, 119, 0.3);
        }
        .header h1 { margin: 0; font-size: 36px; font-weight: 700; text-align: center; }
        .nav-tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; justify-content: center; }
        .nav-tab {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px; border-radius: 12px; cursor: pointer; transition: 0.3s; color: white;
        }
        .nav-tab.active { background: white; color: #379777; border: 2px solid #f4ce14; font-weight: bold; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #45474b; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 12px; background: rgba(255,255,255,0.6); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; border: none; }
        .btn-primary { background: #379777; color: white; }
        .btn-secondary { background: #f4ce14; color: #45474b; }
        .stat-card { padding: 30px; border-radius: 20px; color: white; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.15); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.6); border-radius: 15px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: right; }
        thead { background: #379777; color: white; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #379777; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p class="mt-4 font-bold text-green-800">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<div class="container">
    <div class="official-header">
        <div class="official-title">Ø§Ù„Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦ÙŠØ© Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¬Ø¯Ø©</div>
        <div class="text-lg font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹Ø§ÙˆÙ‰ ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</div>
        <div class="text-md font-bold">Ù‚Ø³Ù… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</div>
    </div>

    <div class="header">
        <h1>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</h1>
        <div class="nav-tabs no-print">
            <button class="nav-tab active" onclick="switchPage('charts', this)">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button class="nav-tab" onclick="switchPage('data', this)">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="nav-tab" onclick="switchPage('entry', this)">â• Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <div id="page-charts" class="page active">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card" style="background: #379777;">
                <div class="text-4xl mb-2">ğŸ“‹</div>
                <div class="text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                <div id="stat-total" class="text-3xl font-bold">0</div>
            </div>
            <div class="stat-card" style="background: #f4ce14; color: #45474b;">
                <div class="text-4xl mb-2">ğŸ›ï¸</div>
                <div class="text-sm">Ø£ÙƒØ«Ø± Ø¯Ø§Ø¦Ø±Ø©</div>
                <div id="stat-dept" class="text-xl font-bold">-</div>
            </div>
            <div class="stat-card" style="background: #45474b;">
                <div class="text-4xl mb-2">ğŸ”„</div>
                <div class="text-sm">Ø£ÙƒØ«Ø± Ø³Ø¨Ø¨</div>
                <div id="stat-reason" class="text-lg font-bold">-</div>
            </div>
            <div class="stat-card" style="background: #379777;">
                <div class="text-4xl mb-2">ğŸ¯</div>
                <div class="text-sm">Ø£ÙƒØ«Ø± ØµÙØ©</div>
                <div id="stat-capacity" class="text-xl font-bold">-</div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card"><canvas id="chart-dept"></canvas></div>
            <div class="card"><canvas id="chart-cap"></canvas></div>
        </div>
    </div>

    <div id="page-data" class="page">
        <div class="card overflow-x-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-green-800">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
                <button onclick="fetchData()" class="btn btn-primary text-xs">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th>
                        <th>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</th>
                        <th>Ø§Ù„ØµÙØ©</th>
                        <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="page-entry" class="page">
        <div class="card max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-green-700 mb-6 border-b pb-2">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="entryForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group"><label>Ø§Ù„ÙŠÙˆÙ… *</label><select id="f-day" required><option value="">Ø§Ø®ØªØ±</option><option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option></select></div>
                    <div class="form-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" id="f-date" required></div>
                    <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" id="f-name"></div>
                    <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="f-id"></div>
                    <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©</label><input type="text" id="f-case"></div>
                    <div class="form-group"><label>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© *</label><select id="f-dept" required><option value="">Ø§Ø®ØªØ±</option><option>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option><option>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option><option>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option><option>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</option><option>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©</option><option>Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</option><option>ØºÙŠØ± Ù…Ù‚ÙŠØ¯</option></select></div>
                    <div class="form-group"><label>Ø§Ù„ØµÙØ© *</label><select id="f-cap" required><option value="">Ø§Ø®ØªØ±</option><option>Ø£ØµÙŠÙ„ Ù…Ø¯Ø¹ÙŠ</option><option>Ø£ØµÙŠÙ„ Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡</option><option>ÙˆÙƒÙŠÙ„</option><option>Ù…Ø­Ø§Ù…ÙŠ</option><option>Ø´Ø§Ù‡Ø¯</option></select></div>
                    <div class="form-group"><label>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø®ØªØµ *</label><select id="f-emp" required><option value="">Ø§Ø®ØªØ±</option><option>Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</option><option>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø«Ø¨ÙŠØªÙŠ</option><option>ÙÙŠØµÙ„ Ø§Ù„Ø¬Ù‡Ù†ÙŠ</option><option>Ù…ØªØ¹Ø¨ Ø§Ù„ØµØ§Ø¹Ø¯ÙŠ</option><option>Ø£ÙƒØ±Ù… Ø§Ù„ØµØ¨Ø­ÙŠ</option><option>Ø­Ù…ÙŠØ¯ Ø§Ù„Ø³Ù„Ù…ÙŠ</option></select></div>
                    <div class="form-group md:col-span-2"><label>Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© *</label><select id="f-reason" required><option value="">Ø§Ø®ØªØ±</option><option>Ø·Ù„Ø¨ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù‚Ø¶ÙŠØ©</option><option>ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰ Ù„Ù…ÙƒØªØ¨ ÙØ¶ÙŠÙ„Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø­ÙƒÙ…Ø©</option><option>Ø·Ù„Ø¨ ØµÙˆØ±Ø© Ù…Ù† ØµÙƒ Ø§Ù„Ø­ÙƒÙ…</option><option>Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù…Ø¹Ø§Ù…Ù„Ø©</option><option>Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ù„Ø³Ø©</option></select></div>
                </div>
                <button type="submit" class="btn btn-primary w-full py-4 text-xl justify-center mt-4">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </form>
        </div>
    </div>

    <footer class="site-footer mt-10">
        <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024 - Ø´Ø±Ù Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ</p>
    </footer>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjGFsxXiOdz9iEvV2YCgXAqm1_r2T7CO5sW0JwgEkFi0TOKK3Lp_Y491VQ4Q0NAMUAxQ/exec";
    let allData = [];
    let charts = {};

    // 1. Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    function switchPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        btn.classList.add('active');
        if(pageId === 'charts') updateDashboard();
    }

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬ÙˆØ¬Ù„
    async function fetchData() {
        toggleLoading(true);
        try {
            const res = await fetch(SCRIPT_URL);
            allData = await res.json();
            renderTable();
            updateDashboard();
        } catch (e) { console.error("Error fetching data:", e); }
        toggleLoading(false);
    }

    // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¬ÙˆØ¬Ù„
    document.getElementById('entryForm').onsubmit = async (e) => {
        e.preventDefault();
        toggleLoading(true);

        const record = {
            day: document.getElementById('f-day').value,
            date: document.getElementById('f-date').value,
            beneficiary_name: document.getElementById('f-name').value,
            id_number: document.getElementById('f-id').value,
            case_number: document.getElementById('f-case').value,
            department: document.getElementById('f-dept').value,
            capacity: document.getElementById('f-cap').value,
            description: document.getElementById('f-reason').value,
            employee: document.getElementById('f-emp').value,
            created_at: new Date().toISOString()
        };

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Ù„ØªØ¬Ø§ÙˆØ² Ù…Ø´Ø§ÙƒÙ„ CORS Ù…Ø¹ Google Apps Script
                body: JSON.stringify(record)
            });
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById('entryForm').reset();
            fetchData(); // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
        } catch (err) { alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        toggleLoading(false);
    };

    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = allData.slice().reverse().map(r => `
            <tr>
                <td>${r.date}</td>
                <td>${r.beneficiary_name || '-'}</td>
                <td>${r.department}</td>
                <td>${r.capacity}</td>
                <td>${r.description}</td>
                <td>${r.employee}</td>
            </tr>
        `).join('');
    }

    // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
    function updateDashboard() {
        if(allData.length === 0) return;

        document.getElementById('stat-total').innerText = allData.length;
        
        const counts = { dept: {}, cap: {}, reason: {} };
        allData.forEach(r => {
            counts.dept[r.department] = (counts.dept[r.department] || 0) + 1;
            counts.cap[r.capacity] = (counts.cap[r.capacity] || 0) + 1;
            counts.reason[r.description] = (counts.reason[r.description] || 0) + 1;
        });

        const top = (obj) => Object.entries(obj).sort((a,b)=>b[1]-a[1])[0][0];
        document.getElementById('stat-dept').innerText = top(counts.dept);
        document.getElementById('stat-capacity').innerText = top(counts.cap);
        document.getElementById('stat-reason').innerText = top(counts.reason);

        initChart('chart-dept', 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±', counts.dept, 'bar');
        initChart('chart-cap', 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØµÙØ§Øª', counts.cap, 'pie');
    }

    function initChart(canvasId, label, dataObj, type) {
        if(charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(document.getElementById(canvasId), {
            type: type,
            data: {
                labels: Object.keys(dataObj),
                datasets: [{
                    label: label,
                    data: Object.values(dataObj),
                    backgroundColor: ['#379777', '#f4ce14', '#45474b', '#2d7a5f', '#e0bc00']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function toggleLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    window.onload = fetchData;
</script>
</body>
</html>
